{% extends 'results_base_custom.html' %}
{% block body %}
    {% block title %}
    <h3>Test: {{ test_name }}</h3>
    {% endblock %}
    <h3>
        <span>Test start time: </span>
        <span class="blue">{{ test_start_time }}</span>
        <br>
        <span>Test id: </span>
        <span class="blue">{{ test_id }}</span>
        <br>
        <span>Scylla Server Version: </span>
        {% if build_id %}
            <span class="blue">{{ test_version }} with build-id {{ build_id }}</span>
        {% else %}
            <span class="blue">{{ test_version }}</span>
        {% endif %}
    </h3>
    <div>
        <span> Setup Details: </span>
        <ul>
        {% for key, val in setup_details.items()|sort %}
            <li>
                {{ key }}: <span class="blue"> {{ val }} </span>
            </li>
        {% endfor %}
        </ul>
    </div>
    <div>
        <h3>
            <span>Amount of reactor stalls:</span>
            <span class="blue">{{ reactor_stall_events_summary.get('DEBUG', 0) }}</span>
        </h3>
        <h3>
            <span>Amount of kernel callstacks:</span>
            <span class="blue">{{ kernel_callstack_events_summary.get('DEBUG', 0) }}</span>
        </h3>
    </div>
    <div>
        <h2> Total test HDR Histogram percentiles</h2>
        <table id="results_table">
            <th> Workload </th>
            <th> Start time </th>
            <th> End time </th>
            <th> Percentile 50 </th>
            <th> Percentile 90 </th>
            <th> Percentile 99 </th>
            <th> Percentile 99.9 </th>
            {% for workload, total in test_histogram['total'].items() %}
                <tr>
                    <td> {{ workload }} </td>
                    <td> {{ total['start_time'] | format_timestamp }} </td>
                    <td> {{ total['end_time'] | format_timestamp }} </td>
                    <td> {{ total["percentile_50"] }}</td>
                    {% if total["percentile_90"] > 10  %}
                        <td style="background-color: red"> {{ total["percentile_90"] }}</td>
                    {% else %}
                        <td > {{ total["percentile_90"] }}</td>
                    {% endif %}
                    {% if total["percentile_99"] > 15  %}
                        <td style="background-color: red"> {{ total["percentile_99"] }}</td>
                    {% else %}
                        <td > {{ total["percentile_99"] }}</td>
                    {% endif %}
                    <td> {{ total["percentile_99_9"] }}</td>
                </tr>
            {% endfor %}
        </table>
    </div>
        <div>
            {% for operation, results in stats.items() %}
                <h2> Total {{ operation }} HDR Histogram percentiles</h2>
                <table id="results_table">
                    <th> Workload </th>
                    <th> Start time </th>
                    <th> End time </th>
                    <th> Percentile 50 </th>
                    <th> Percentile 90 </th>
                    <th> Percentile 99 </th>
                    <th> Percentile 99.9 </th>
                    {% if results.get('hdr') %}
                        {% for workload, data in results['hdr_summary'].items() %}
                            <tr>
                                <td> {{ workload }} </td>
                                <td> {{ data['start_time'] | format_timestamp }} </td>
                                <td> {{ data['end_time'] | format_timestamp }} </td>
                                <td> {{ data["percentile_50"] }}</td>
                                {% if data["percentile_90"] > 10  %}
                                    <td style="background-color: red"> {{ data["percentile_90"] }}</td>
                                {% else %}
                                    <td > {{ data["percentile_90"] }}</td>
                                {% endif %}
                                {% if data["percentile_99"] > 15  %}
                                    <td style="background-color: red"> {{ data["percentile_99"] }}</td>
                                {% else %}
                                    <td > {{ data["percentile_99"] }}</td>
                                {% endif %}

                                <td> {{ data["percentile_99_9"] }}</td>
                            </tr>
                        {% endfor %}
                    {% else %}
                        {% for row in results.get('cycles') %}
                            {% set cycle_index = loop.index %}
                            {% if row.get('hdr_summary') %}
                                <tr>
                                    <td colspan="100%"> Cycle #{{ cycle_index }} </td>
                                </tr>
                                {% for workload, data in row['hdr_summary'].items() %}
                                    <tr>
                                        <td> {{ workload }} </td>
                                        <td> {{ data['start_time'] | format_timestamp }} </td>
                                        <td> {{ data['end_time'] | format_timestamp }} </td>
                                        <td> {{ data["percentile_50"] }}</td>
                                        {% if data["percentile_90"] > 10  %}
                                            <td style="background-color: red"> {{ data["percentile_90"] }}</td>
                                        {% else %}
                                            <td > {{ data["percentile_90"] }}</td>
                                        {% endif %}
                                        {% if data["percentile_99"] > 15  %}
                                            <td style="background-color: red"> {{ data["percentile_99"] }}</td>
                                        {% else %}
                                            <td > {{ data["percentile_99"] }}</td>
                                        {% endif %}
                                        <td> {{ data["percentile_99_9"] }}</td>
                                    </tr>
                                {% endfor %}
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                </table>

                {% if operation != 'Steady State' %}
                    <h2>{{ operation }}</h2>
                    <table id="results_table">
                        <caption>{{ results['legend'] }}</caption>
                        <th> Scylla build </th>
                        <th>Latency Type</th>
                        {% for cycle in results['cycles'] %}
                            <th>Cycle #{{ loop.index }}</th>
                        {% endfor %}
                        <th>Cycles Average</th>
                        <th>Steady State</th>
                        <th>Relative to Steady</th>
                        <th>Commit id, date</th>
                        {% set lat_type_list = ['c-s P99'] %}

                        {% for lat_type in lat_type_list|sort %}
                                {% if 'color' in results and lat_type in results['color'] and results['color'][lat_type] == 'red' %}
                                    <tr style ="background-color: red">
                                {% else %}
                                       <tr>
                                {% endif %}
                            {% else %}
                                <tr>
                            {% endif %}
                            <td> current build </td>
                            <td>{{ lat_type }}</td>
                            {% for cycle in results['cycles'] %}
                                <td>{{ cycle[lat_type] }}</td>
                                {% if lat_type ~ "_stdev" in cycle %}
                                    <td>{{ cycle[lat_type ~ "_stdev"] }}</td>
                                {% else %}
                                    <td>-</td>
                                {% endif %}
                                {% if lat_type ~ "_points_above_threshold" in cycle %}
                                    <td>{{ cycle[lat_type ~ "_points_above_threshold"] }}</td>
                                {% else %}
                                    <td>-</td>
                                {% endif %}
                        {% endfor %}
                        <td>{{ results['Cycles Average'][lat_type] }}</td>
                        <td>{{ stats['Steady State'][lat_type] }}</td>
                        <td>{{ results['Relative to Steady'][lat_type] }}</td>
                        <td>{{ test_version }} </td>
                        </tr>


                        {% if best_stat_per_version and best_stat_per_version.get(operation) %}
                            <tr><td colspan="100%" align="center">Previous version results</td></tr>
                            {% for version, best in best_stat_per_version[operation].items() %}
                            <tr>
                                <td> {{ version }} </td>
                                <td> {{ lat_type }} </td>
                                {% for cycle in results['cycles'] %}
                                    <td></td>
                                {% endfor %}
                                <td>{{ best.get('Cycles Average')['c-s P99'] }}</td>
                                <td>{{ best_stat_per_version['Steady State'][version]['c-s P99'] }}</td>
                                <td>{{ best.get('Relative to Steady')['c-s P99'] }}</td>
                                <td>{{ best.get('version')['commit_id'] }},<br/>{{ best.get('version')['date'] }}</td>
                            </tr>
                            {% endfor %}
                        {% endif %}
                    {% endfor %}
                    </table>
                    <span STYLE="font-size:12px" class="red">* All latency values are in ms.</span>
                    <div>
                        {% for cycle in results['cycles'] %}
                            {% for screenshot in cycle['screenshots'] %}
                                <span style="vertical-align: top"><img src="{{ screenshot }}"  height="250" width="150"></span>
                            {% endfor %}
                        {% endfor %}
                    </div>
                {% endif %}
            {% endfor %}
        </div>
{% endblock %}
